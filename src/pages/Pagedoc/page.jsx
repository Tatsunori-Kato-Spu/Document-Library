import React, { useState } from "react";
import { FontAwesomeIcon } from "@fortawesome/react-fontawesome";
import { faEnvelope, faStar } from "@fortawesome/free-solid-svg-icons";
import { faStar as faRegStar } from "@fortawesome/free-regular-svg-icons";
import "./page.css";
import { docdata } from "../../data/docdata";
import Searchbar from "../Searchbar/Searchbar";
import Actiondropdown from "../actiondropdown/actiondropdown";
import Dropdown from "react-bootstrap/Dropdown";
import ButtonUpload from "../AddDoc/buttonupload"; 
import Header from "../../Layout/Header/Header";
import { useNavigate } from "react-router-dom";

const Pagedoc = ({ userRole }) => {
  // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (State variables)
  const [filteredData, setFilteredData] = useState(
    docdata.map((item) => ({ ...item, isFavorite: false, isRead: false })) 
  );
  const [sortOrder, setSortOrder] = useState("desc");
  const [activeDropdown, setActiveDropdown] = useState(null);
  const [showModal, setShowModal] = useState(false);
  const [selectedDoc, setSelectedDoc] = useState(null);
  const navigate = useNavigate();

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
  const handleSearch = (filteredDocuments) => {
    setFilteredData(filteredDocuments); 
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Dropdown
  const handleDropdownToggle = (e, index) => {
    e.stopPropagation();
    setActiveDropdown(activeDropdown === index ? null : index);
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
  const handleSortByDate = () => {
    const sortedData = [...filteredData].sort((a, b) => {
      const dateA = new Date(a["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"].split("/").reverse().join("-"));
      const dateB = new Date(b["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"].split("/").reverse().join("-"));
      return sortOrder === "desc" ? dateB - dateA : dateA - dateB;
    });
    setFilteredData(sortedData);
    setSortOrder(sortOrder === "desc" ? "asc" : "desc");
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö
  const handleSortByOrder = () => {
    const sortedData = [...filteredData].sort((a, b) => {
      const orderA = parseInt(a["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç"]);
      const orderB = parseInt(b["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç"]);
      return sortOrder === "desc" ? orderB - orderA : orderA - orderB;
    });
    setFilteredData(sortedData);
    setSortOrder(sortOrder === "desc" ? "asc" : "desc");
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏î‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô Favorite
  const handleStarClick = (index) => {
    const newData = [...filteredData];
    newData[index].isFavorite = !newData[index].isFavorite;
    setFilteredData(newData);
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß")
  const handleRowClick = (item) => {
    const newData = [...filteredData];
    const index = filteredData.findIndex(doc => doc["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç"] === item["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç"]);
    newData[index].isRead = true; 
    setFilteredData(newData); 
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
  const handleShowModal = (doc) => {
    setSelectedDoc(doc);
    setShowModal(true);
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
  const handleDelete = () => {
    setFilteredData(
      filteredData.filter((item) => item["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç"] !== selectedDoc["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç"])
    );
    setShowModal(false);
    setSelectedDoc(null);
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
  const handleDownload = (docId) => {
    const fileUrl = `/files/${docId}.pdf`;  
    const link = document.createElement('a');
    link.href = fileUrl;
    link.download = `${docId}.pdf`; 
    document.body.appendChild(link); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏•‡∏á‡πÉ‡∏ô DOM
    link.click(); // ‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å
    document.body.removeChild(link); // ‡∏•‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DOM
  };
  

  return (
    <>
      <div className="page-container">
        <Header />
        {/* ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ */}
        <div className="searchbar-container">
          <Searchbar onSearch={handleSearch} searchType="documents" />
        </div>

        {/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ */}
        <div className="table-wrapper">
          <table className="table-contenner">
            <thead className="table-th">
              <tr>
                <th></th>
                <th>
                  ‡∏•‡∏≥‡∏î‡∏±‡∏ö
                  <button className="icon-button" onClick={handleSortByOrder}>
                    {sortOrder === "desc" ? "üîΩ" : "üîº"}
                  </button>
                </th>
                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
                <th>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
                <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                <th>
                  ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                  <button className="icon-button" onClick={handleSortByDate}>
                    {sortOrder === "desc" ? "üîΩ" : "üîº"}
                  </button>
                </th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {filteredData.length > 0 ? (
                filteredData.map((item, index) => (
                  <tr
                    key={index}
                    className={item.isRead ? "row-read" : "row-unread"} 
                    onClick={() => handleRowClick(item)} 
                  >
                    {/* ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Favorite */}
                    <td>
                      <FontAwesomeIcon
                        icon={item.isFavorite ? faStar : faRegStar}
                        style={{
                          cursor: "pointer",
                          color: item.isFavorite ? "#FF8539" : "#ccc",
                        }}
                        onClick={() => handleStarClick(index)}
                      />
                    </td>
                    <td>{index + 1}</td>
                    <td>{item["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç"]}</td>
                    <td>{item["‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"]}</td>
                    <td>{item["‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á"]}</td>
                    <td>{item["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"]}</td>
                    <td>{item["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"]}</td>
                    <td>{item["‡πÄ‡∏ß‡∏•‡∏≤"]}</td>

                    {/* Dropdown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥ */}
                    <div className="dropdown">
                      <Dropdown>
                        <Dropdown.Toggle variant="success" id="dropdown-basic">
                          <i className="bi bi-list"></i>
                        </Dropdown.Toggle>
                        <Dropdown.Menu>
                          {userRole === "admin" && (
                            <>
                              <Dropdown.Item
                                className="bi bi-pencil-square"
                                onClick={() => navigate("/addDoc", { state: { doc: item } })}
                              >
                                {" "}&nbsp;‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                              </Dropdown.Item>
                              <Dropdown.Item
                                href="#/action-2"
                                className="bi bi-box-arrow-down"
                                onClick={() => handleDownload(item["‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"])}
                              >
                                {" "}&nbsp;Download
                              </Dropdown.Item>
                              <Dropdown.Item
                                href="#/action-3"
                                className="bi bi-trash"
                                onClick={() => handleShowModal(item)}
                              >
                                {" "}&nbsp;‡∏•‡∏ö
                              </Dropdown.Item>
                            </>
                          )}
                          {userRole === "worker" && (
                            <>
                              <Dropdown.Item
                                href="#/action-2"
                                className="bi bi-box-arrow-down"
                                onClick={() => handleDownload(item["‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"])}
                              >
                                {" "}&nbsp;Download
                              </Dropdown.Item>
                            </>
                          )}
                          {userRole === "guest" && (
                            <>
                              <Dropdown.Item
                                href="#/action-2"
                                className="bi bi-box-arrow-down"
                                onClick={() => handleDownload(item["‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"])}
                              >
                                {" "}&nbsp;Download
                              </Dropdown.Item>
                            </>
                          )}
                        </Dropdown.Menu>
                      </Dropdown>
                    </div>
                  </tr>
                ))
              ) : (
                <tr>
                  <td colSpan="7">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</td>
                </tr>
              )}
            </tbody>
          </table>
        </div>

        {/* ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin */}
        {userRole === "admin" && <ButtonUpload />}

        {/* Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö */}
        <Actiondropdown
          show={showModal}
          onClose={() => setShowModal(false)}
          onConfirm={handleDelete}
          docName={selectedDoc?.["‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"]}
        />
      </div>
    </>
  );
};

export default Pagedoc;
